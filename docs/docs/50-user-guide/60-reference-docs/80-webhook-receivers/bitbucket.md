---
sidebar_label: Bitbucket
---

# The Bitbucket Webhook Receiver

## Secret Configuration

The Kargo Bitbucket webhook receiver will require a Kubernetes secret. This secret is required to contain a `secret` key in its `stringData` field. You'll be required to provide the value assigned to the `secret` key to Bitbucket in a later step, so keep it handy.

```yaml
apiVersion: v1
kind: Secret
metadata:
    name: bb-wh-secret
    namespace: kargo-project-namespace
stringData:
    # Replace 'your-secret-here' with any non-empty
    # arbitrary string data.
    # The key here is required to be named 'secret'.
    secret: your-secret-here
```
Bitbucket will sign payloads using this secret via HMAC signature. The Kargo Bitbucket webhook receiver will use this secret to verify the signature.

:::note
If you generate the secret directly from the Bitbucket UI, make sure to pass the
secret value generated by the Bitbucket to the `secret` field.
:::

## Bitbucket Webhook Receiver Configuration

Create a new project config specifying the Bitbucket webhook receiver that references the secret created previously.

```yaml
apiVersion: kargo.akuity.io/v1alpha1
kind: ProjectConfig
metadata:
  name: my-project-config
  namespace: kargo-project-namespace
spec:
  webhookReceivers: 
    - name: bb-wh-receiver
      bitbucket:
        secretRef:
          name: bb-wh-secret
```

## Retrieving the Webhook URL

The secret (among other things) will be used as an input to generate
a secure URL for our newly created webhook receiver. We can obtain
this URL using the following command:

```
kubectl \
    get projectconfigs \
    my-project-config \
    -n kargo-project-namespace \
    -o=jsonpath='{.status.webhookReceivers[0].url}'
```

:::note
If your project config has configured multiple webhook receivers, it is recommended to describe the `ProjectConfig` resource in the kargo project namespace and copy the URL. For example, 
```
kubectl \
    describe projectconfig \
    my-project-config \
    -n kargo-project namespace
```
:::

## Configure on Bitbucket

**Step 1:** Naviate to *Repository settings* 

![Step 1](/img/bitbucket/01.png "Repository settings")

**Step 2:** Navigate to *Webhooks* under *Workflow*

![Step 2](/img/bitbucket/02.png "Webhooks")

**Step 3:** Create a New Webhook

    - Click on `Add webhook` button
    - Specify a webhook Title in the `Title` field.
    - Specify the `URL` retrieved from the [Retrieving the Webhook URL](#retrieving-the-webhook-url) step.
    - Either generate a secret from the Bitbucket UI and add the value to the secret created in [Secret Configuration](#secret-configuration) step. Otherwise, use the value specified in the secret key and paste it on UI.
    - Mark the *Status* to Active if not already.
    - Skip certificate verification if necessary (not recommended)
    - Mark `Push` event as a Trigger.

    - Finally, click on `Save`.


![Step 3](/img/bitbucket/04.png "Create New Webhook")

**Step 4:** Verify Connectivity

<!-- TODO -->